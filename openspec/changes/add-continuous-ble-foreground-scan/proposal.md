# Proposal: Add Continuous BLE Foreground Scan with RSSI-based Room Detection

## Background

現在の実装では、ジオフェンス内で定期的に BLE スキャンを実行しているが、以下の問題がある:

1. **断続的なスキャン**: 15 分間隔の定期タスクで短時間（15 秒）だけスキャンし、検出後すぐに停止する
2. **フォアグラウンドサービスの短時間利用**: スキャン中のみフォアグラウンドサービスを起動し、検出後すぐに停止するため、Android のバックグラウンド制限で BLE 検出が不安定
3. **RSSI による距離判定なし**: ビーコンの検出/未検出の 2 値判定のみで、RSSI 値を使った「研究室内」と「学内廊下」の区別ができない
4. **状態 2/状態 3 の遷移が不明確**: `INSIDE_AREA`（学内）と `PRESENT`（研究室内）の遷移ロジックが RSSI ベースではなく、接続成功のみで判定している

## Proposal

ジオフェンス ENTER 時に Android フォアグラウンドサービスを起動し、**学内にいる間は常時 BLE スキャンを継続**する。RSSI 値を監視して研究室の入退室を判定し、ジオフェンス EXIT 時にサービスを停止する。

### 主要な変更:

1. **常時スキャンモードの追加**

   - ジオフェンス ENTER → フォアグラウンドサービス開始 → BLE スキャン開始（stopDeviceScan を呼ばない）
   - ジオフェンス EXIT → BLE スキャン停止 → フォアグラウンドサービス停止

2. **RSSI ベースの入退室判定**

   - RSSI しきい値（例: -70 dBm）を定義
   - RSSI > しきい値 → `PRESENT`（研究室内）
   - RSSI <= しきい値 → `INSIDE_AREA`（学内廊下）または `UNCONFIRMED`（一時的な信号喪失）

3. **状態遷移の明確化**

   - `OUTSIDE` → ジオフェンス ENTER → `INSIDE_AREA`
   - `INSIDE_AREA` + 強い RSSI 検出 → `PRESENT`
   - `PRESENT` + 弱い RSSI または未検出 → `UNCONFIRMED` → (猶予期間後) → `INSIDE_AREA`
   - `INSIDE_AREA` → ジオフェンス EXIT → `OUTSIDE`

4. **定期タスクの役割変更**
   - 常時スキャン中は定期タスクをスキップ（重複スキャン防止）
   - フォアグラウンドサービスが異常終了した場合のフォールバックとして維持

## Benefits

- **リアルタイム検出**: 15 分間隔ではなく、ビーコン信号を常時監視することで、入退室のタイムラグを数秒に短縮
- **RSSI による精度向上**: 廊下と研究室を区別し、誤検出を削減
- **Android バックグラウンド対応**: フォアグラウンドサービスにより、Android 13+ のバックグラウンド BLE 制限を回避
- **バッテリー効率**: 学外では完全にスキャンを停止し、学内のみ常時スキャンすることで、無駄な電力消費を抑制

## Risks & Mitigations

### Risk 1: バッテリー消費増加

- **軽減策**: ジオフェンス外では完全にスキャン停止。iOS では iBeacon 領域監視の検討（将来的な改善）

### Risk 2: フォアグラウンドサービス通知の常駐による UX 低下

- **軽減策**: 通知文言を「研究室ビーコンを監視しています」と明確化し、ユーザーがサービスの目的を理解できるようにする

### Risk 3: RSSI の不安定性

- **軽減策**:
  - 複数回の RSSI サンプル平均をとる
  - ヒステリシス（しきい値に幅を持たせる）を導入
  - 状態遷移に猶予期間（例: 3 分間）を設ける

### Risk 4: iOS でのフォアグラウンドサービス非対応

- **軽減策**: iOS では既存の定期タスク + State Restoration を継続し、Android のみ常時スキャンを適用

## Impact

- **変更対象ファイル**:

  - `tasks/geofencingTask.ts`: ジオフェンス ENTER/EXIT でスキャン開始/停止
  - `tasks/periodicCheckTask.ts`: 常時スキャン中はスキップするロジック追加
  - `constants/index.ts`: RSSI しきい値定数を追加
  - `utils/androidBackground.ts`: フォアグラウンドサービスのライフサイクル管理
  - `state/appState.ts`: 状態遷移ロジックの明確化（必要に応じて）

- **新規追加ファイル**:

  - `tasks/continuousBleScanner.ts`: 常時スキャンロジックをカプセル化（オプション）

- **影響範囲**:
  - Android: 中程度（フォアグラウンドサービスのライフサイクル変更）
  - iOS: 小（既存の定期タスクを維持）
  - バックエンド API: 影響なし

## Open Questions

1. RSSI しきい値（-70 dBm）は適切か？実測データに基づいて調整が必要
2. 常時スキャンの実装を `geofencingTask.ts` に統合するか、別ファイルに分離するか？
3. 状態 `UNCONFIRMED` から `INSIDE_AREA` への遷移猶予期間は何秒が適切か？
4. iOS でも将来的に iBeacon 領域監視に移行するか？（現在は LINBLE が iBeacon 非対応のため保留）
