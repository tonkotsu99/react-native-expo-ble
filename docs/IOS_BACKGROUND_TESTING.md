# iOS バックグラウンド検証ガイド

このガイドでは、iOS デバイス上でジオフェンシングと BLE スキャンがバックグラウンドで正しく動作しているかを確認する方法を説明します。

## 前提条件

1.  **iOS 実機**: シミュレータは Bluetooth をサポートしていないため、必ず実機が必要です。
2.  **開発ビルド**: Expo Go ではなく、開発用ビルド (EAS Build / Dev Client) を使用する必要があります。
3.  **Mac (推奨)**: `Console.app` を使用してリアルタイムログを確認するため。

## 1. ビルドとインストール

iOS 用の開発クライアントをビルドします:

```bash
eas build --profile development --platform ios
```

生成されたビルドを実機にインストールします（TestFlight または AdHoc/Internal Distribution）。

## 2. 初期設定

1.  アプリを開きます。
2.  **ログイン**: ユーザー ID が設定されていることを確認します (設定 -> ユーザー ID)。
3.  **権限**:
    - **位置情報**権限: 「常に許可」を選択してください。
      - _注意_: 最初は「使用中のみ許可」しか選べない場合があります。その場合、一度アプリを閉じてしばらくするか、設定アプリから手動で「常に許可」に変更してください。バックグラウンドジオフェンシングには必須です。
    - **Bluetooth** 権限: 許可してください。
    - **通知**権限: 許可してください。

## 3. 検証手順

### A. ログの準備 (Console.app)

iOS のバックグラウンドログは Xcode のデバッガがアタッチされていないと見えにくいですが、macOS の `Console.app` を使うと確認できます。

1.  iPhone を Mac に USB 接続します。
2.  Mac で `Console.app` (コンソール) を開きます。
3.  左側のデバイスリストから iPhone を選択します。
4.  右上の検索バーに `Geofencing Task` または `Periodic Check` と入力し、エンターキーを押してフィルタリングします。
5.  「開始」ボタンを押してログのストリーミングを開始します。

### B. ジオフェンス進入 (実地テスト)

**目的**: アプリが研究室エリアへの進入を検知し、スキャンを開始することを確認する。

1.  **アクション**:

    - アプリをバックグラウンドにします（ホーム画面に戻るか、画面をロック）。
    - 実際にジオフェンスエリア外からエリア内へ移動します。

2.  **期待される結果**:
    - **通知**: ローカル通知「Geofence Entered」が表示されること。
    - **通知**: （デバッグモード時）「Background Scan Started」が表示されること。
    - **Console.app ログ**:
      ```
      [Geofencing Task] Event received: ... eventType: ENTER ...
      [Geofencing Task] Starting continuous BLE scan...
      ```

### C. BLE 検知と出席登録

**目的**: バックグラウンド状態でアプリがビーコンを検知し、出席を送信することを確認する。

1.  **準備**: 正しい Service UUID を持つ BLE ビーコンが近くで動作していることを確認します。

2.  **アクション**: ジオフェンス進入後、数秒待ちます。

3.  **期待される結果**:
    - **通知**: 「Attendance Recorded: [デバイス名]」 (デバッグ通知) が表示されること。
    - **Console.app ログ**:
      ```
      [Geofencing Task] Strong RSSI detected ...
      [Geofencing Task] API Success: POST to ...
      ```

### D. ジオフェンス退出

**目的**: エリアから出た際にアプリがスキャンを停止することを確認する。

1.  **アクション**:

    - 実際にジオフェンスエリアの外へ移動します。

2.  **期待される結果**:
    - **通知**: 「Geofence Exited」が表示されること。
    - **Console.app ログ**:
      ```
      [Geofencing Task] Event received: ... eventType: EXIT ...
      [Geofencing Task] Continuous scan stopped successfully
      ```

### E. 定期チェック (メンテナンス)

**目的**: バックグラウンドフェッチが動作し、定期的にスキャンが行われるか確認する。

1.  **アクション**:

    - iOS のバックグラウンドフェッチは OS の判断で実行されるため、強制は難しいですが、Xcode の "Simulate Background Fetch" 機能を使うか、長時間放置してログを確認します。

2.  **期待される結果**:
    - **Console.app ログ**: `[Periodic Check] ...`
    - **通知**: 「Background Scan Started」 (デバッグ通知)。

## トラブルシューティング

- **ログが表示されない?**: Console.app の検索フィルタが正しいか確認してください。また、デバイスが正しく接続されているか確認してください。
- **通知が来ない?**: 設定アプリで通知が許可されているか、また「集中モード」などで通知が抑制されていないか確認してください。
- **位置情報が反応しない?**: 設定アプリで「正確な位置情報」がオンになっているか、「常に許可」になっているか再確認してください。
