# Android バックグラウンド検証ガイド

このガイドでは、Android デバイス上でジオフェンシングと BLE スキャンがバックグラウンドで正しく動作しているかを確認する方法を説明します。

## 前提条件

1.  **Android 実機**: エミュレータは Bluetooth のサポートが限定的であり、バックグラウンド制限の挙動も異なるため、実機が必要です。
2.  **開発ビルド**: Expo Go ではなく、開発用ビルド (EAS Build) またはローカルビルドを使用する必要があります。
3.  **ADB のインストール**: ログを確認するために必要です。

## 1. ビルドとインストール

Android 用の開発クライアントをビルドします:

```bash
eas build --profile development --platform android
```

APK をダウンロードし、デバイスにインストールしてください。

## 2. 初期設定

1.  アプリを開きます。
2.  **ログイン**: ユーザー ID が設定されていることを確認します (設定 -> ユーザー ID)。
3.  **権限**:
    - **位置情報**権限: 「常に許可」を選択してください (バックグラウンドでのジオフェンシングに必須です)。
    - **Bluetooth** 権限: 「付近のデバイス」を許可してください。
    - **通知**権限: 許可してください。
4.  **バッテリー最適化**: プロンプトが表示された場合は、アプリがバッテリー最適化を無視できるように許可してください (または、設定 -> アプリ -> [アプリ名] -> バッテリー -> 制限なし に設定)。

## 3. 検証手順

### A. ジオフェンス進入 (シミュレーションまたは実地)

**目的**: アプリが研究室エリアへの進入を検知し、スキャンを開始することを確認する。

1.  **準備**:

    - USB 経由でデバイスを PC に接続します。
    - ターミナルで `adb logcat -s "Geofencing Task" "Android Background" "Periodic Check"` を実行します。
    - アプリを**バックグラウンド**にします (ホーム画面に戻るか、画面をロックします)。

2.  **アクション**:

    - **実地**: ジオフェンスエリア内に歩いて入ります。
    - **シミュレーション (可能な場合)**: 位置情報偽装アプリを使用して、現在地をジオフェンス内 (緯度: 33.8823, 経度: 130.8797) に移動させます。

3.  **期待される結果**:
    - **通知**: ローカル通知「Geofence Entered」が表示されること。
    - **通知**: 常駐通知「研究室ビーコンを監視しています」(フォアグラウンドサービス) が表示されること。
    - **ログ**:
      ```
      [Geofencing Task] Event received: ... eventType: ENTER ...
      [Geofencing Task] Starting continuous BLE scan...
      [Android Background] Foreground service started ...
      ```

### B. BLE 検知と出席登録

**目的**: バックグラウンド状態でアプリがビーコンを検知し、出席を送信することを確認する。

1.  **準備**: 正しい Service UUID を持つ BLE ビーコンが近くで動作していることを確認します。

2.  **アクション**: ジオフェンス進入後、数秒待ちます。

3.  **期待される結果**:
    - **通知**: 「Attendance Recorded: [デバイス名]」 (デバッグ通知) が表示されること。
    - **ログ**:
      ```
      [Geofencing Task] Strong RSSI detected ...
      [Geofencing Task] API Success: POST to ...
      ```

### C. ジオフェンス退出

**目的**: エリアから出た際にアプリがスキャンを停止することを確認する。

1.  **アクション**:

    - **実地**: ジオフェンスエリアの外へ歩いて出ます。
    - **シミュレーション**: 位置情報を遠く (例: 500m 以上離れた場所) に移動させます。

2.  **期待される結果**:
    - **通知**: 「Geofence Exited」が表示されること。
    - **通知**: 「研究室ビーコンを監視しています」の常駐通知が消えること。
    - **ログ**:
      ```
      [Geofencing Task] Event received: ... eventType: EXIT ...
      [Geofencing Task] Continuous scan stopped successfully
      [Android Background] Foreground service stopped ...
      ```

### D. 定期チェック (メンテナンス)

**目的**: 常時スキャンが失敗したりキルされたりした場合に、アプリが定期的にビーコンをチェックすることを確認する。

1.  **アクション**:

    - これを強制するのは難しいですが、Background Fetch の開発ツールで手動トリガーするか、しばらく (約 15 分) 待ちます。
    - または、「エリア内」にいる状態で長時間ログを監視します。

2.  **期待される結果**:
    - **ログ**: `[Periodic Check] ...`
    - **通知**: 「Background Scan Started」 (デバッグ通知) が表示されること。

## トラブルシューティング

- **ログが表示されない?**: 正しいタグでフィルタリングしているか確認してください。`adb logcat *:S "Geofencing Task":V "Android Background":V` を試してください。
- **通知が表示されない?**: システム設定でアプリの通知が有効になっているか確認してください。
- **アプリがキルされる?**: メモリ不足の場合、Android はアプリをキルすることがあります。フォアグラウンドサービスはこれを防ぐのに役立ちますが、バッテリー使用量を「制限なし」に設定することが重要です。
